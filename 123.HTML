<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數據統計分析系統</title>
    <!-- 引入 Excel 匯出函式庫 -->
    <script src="cdnjs.cloudflare.com"></script>
    <style>
        /* 響應式字體與排版 */
        :root { font-size: calc(14px + 0.5vw); }
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f0f2f5; line-height: 1.6; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; width: 100%; box-sizing: border-box; }
        .sub-menu { background: #f9f9f9; padding: 10px; border-left: 5px solid #007bff; margin-top: 5px; display: none; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 5px; font-size: 1rem; transition: 0.3s; }
        .btn-submit { background: #28a745; color: white; }
        .btn-export { background: #007bff; color: white; }
        button:hover { opacity: 0.8; }
    </style>
</head>
<body>

<div class="container">
    <h2>數據統計登錄系統</h2>
    <form id="dataForm">
        <!-- 自動生成欄位 -->
        <div class="form-group"><label>執行狀況：</label><input type="text" id="status" value="已執行" readonly style="background:#eee;"></div>
        <div class="form-group"><label>日期時間：</label><input type="text" id="datetime" readonly style="background:#eee;"></div>
        
        <!-- 手動填寫欄位 -->
        <div class="form-group"><label>會議類別：</label><input type="text" id="meetingType" placeholder="請輸入會議名稱" required></div>
        <div class="form-group"><label>姓名：</label><input type="text" id="userName" placeholder="請輸入姓名" required></div>
        
        <div class="form-group">
            <label>性別：</label>
            <select id="genderMain">
                <option value="男生">男生</option>
                <option value="女生">女生</option>
                <option value="二次元">二次元</option>
            </select>
        </div>

        <div class="form-group">
            <label>身份別 (不利處境者)：</label>
            
                <option value="無">無 (一般身份)</option>
                <option value="身障者">身障者</option>
                <option value="原住民">原住民</option>
                <option value="新住民">新住民</option>
                <option value="其他">其他</option>
            </select>
            <div id="subGenderContainer" class="sub-menu">
                <label>身份別性別細分：</label>
                <select id="subGender">
                    <option value="男性">男性</option>
                    <option value="女性">女性</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>居住縣市：</label>
            <select id="city">
                <option>台中市</option><option>彰化縣</option><option>南投縣</option>
                <option>雲林縣</option><option>嘉義縣</option><option>嘉義市</option><option>金門縣</option>
            </select>
        </div>

        <div class="form-group">
            <label>年齡：</label>
            <select id="age">
                <option>0~19</option><option>20~29</option><option>30~39</option>
                <option>40~49</option><option>50~59</option><option>60以上</option>
            </select>
        </div>

        <div class="form-group">
            <label>學歷：</label>
            <select id="edu">
                <option>國中以下</option><option>高中職</option><option>副學士</option>
                <option>學士</option><option>碩士</option><option>博士</option>
            </select>
        </div>

        <div class="btn-group">
            <button type="button" class="btn-submit" onclick="submitData()">提交資料</button>
            <button type="button" class="btn-export" onclick="exportToExcel()">匯出 Excel</button>
        </div>
    </form>
</div>

<script>
    let localData = [];
    let recordCount = 1; // 項次計數

    // 初始化日期時間
    function updateTime() {
        const now = new Date();
        document.getElementById('datetime').value = now.toLocaleString('zh-TW');
    }
    setInterval(updateTime, 1000);
    updateTime();

    // 身份別選單連動
    function toggleSubMenu() {
        const type = document.getElementById('identityType').value;
        const subMenu = document.getElementById('subGenderContainer');
        subMenu.style.display = (type !== '無') ? 'block' : 'none';
    }

    async function submitData() {
        const meeting = document.getElementById('meetingType').value;
        const name = document.getElementById('userName').value;
        if(!meeting || !name) return alert('請填寫完整資訊');

        const entry = {
            "項次": recordCount++,
            "執行狀況": "已執行",
            "日期時間": document.getElementById('datetime').value,
            "會議類別": meeting,
            "姓名": name,
            "性別": document.getElementById('genderMain').value,
            "身份別": document.getElementById('identityType').value,
            "身份性別細分": document.getElementById('identityType').value !== '無' ? document.getElementById('subGender').value : '--',
            "居住縣市": document.getElementById('city').value,
            "年齡": document.getElementById('age').value,
            "學歷": document.getElementById('edu').value
        };

        // 存入暫存數組
        localData.push(entry);

        // 提交至免費資料庫 (Google Sheets)
        const scriptURL = 'https://script.google.com/macros/s/AKfycbz7S00sV6E9nGQsOIFnT29vmnzIM6byM9LhxwPFrZJp1cY2WSBZegQuoRicbzT0J0hi/exec'; 
        try {
            // 注意：正式使用需填入部署後的 Apps Script URL
            fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(entry)});
            alert('第 ' + entry.項次 + ' 筆資料已儲存！');
            document.getElementById('userName').value = ""; // 清空姓名方便下一筆
        } catch (e) {
            alert('上傳發生錯誤，資料已暫存在瀏覽器中');
        }
    }

    function exportToExcel() {
        if(localData.length === 0) return alert('無資料可匯出');
        const worksheet = XLSX.utils.json_to_sheet(localData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "數據統計");
        // 下載檔案
        XLSX.writeFile(workbook, `數據彙整表_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>

</body>
</html>
